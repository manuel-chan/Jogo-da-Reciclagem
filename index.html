<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Reciclagem</title>
    <!-- Incluindo o Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo uma fonte do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Usando a fonte Poppins como padrÃ£o */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* AnimaÃ§Ã£o de "..." para o status de espera */
        .waiting-dots::after {
            display: inline-block;
            animation: ellipsis 1.25s infinite;
            content: ".";
            width: 1em;
            text-align: left;
        }
        @keyframes ellipsis {
            0% { content: "."; }
            33% { content: ".."; }
            66% { content: "..."; }
        }
        /* Estilo para o item sendo arrastado */
        .dragging {
            opacity: 0.5;
            transform: scale(0.9);
        }
        /* Estilo para a lixeira quando um item estÃ¡ sobre ela */
        .drag-over {
            border: 3px dashed #333;
        }
    </style>
</head>
<body class="bg-green-100 flex items-center justify-center min-h-screen">

    <!-- Container principal que alterna entre as telas -->
    <div id="app-container" class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl text-center max-w-4xl w-full mx-4 transition-all duration-500">
        
        <!-- Tela de InÃ­cio (Login) -->
        <div id="start-screen">
            <h1 class="text-4xl font-bold text-green-700 mb-4">Jogo da Reciclagem</h1>
            <p class="text-gray-600 mb-8">Digite seu nome para comeÃ§ar a aventura!</p>
            <div class="mb-6">
                <input type="text" id="playerName" placeholder="Seu nome aqui" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-300 text-lg">
                <p id="error-message" class="text-red-500 text-sm mt-2 h-5"></p>
            </div>
            <button id="enterButton" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 active:scale-95 transform transition duration-300 text-xl">
                Entrar
            </button>
        </div>

        <!-- Tela da Sala de Espera (Lobby) -->
        <div id="lobby-screen" class="hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-2">Sala de Espera</h2>
            <p class="text-gray-500 mb-6">Aguardando todos os jogadores ficarem prontos...</p>
            <div id="player-list" class="space-y-3 text-left mb-8 min-h-[100px]"></div>
            <button id="readyButton" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-600 active:scale-95 transform transition duration-300 text-xl">
                Pronto
            </button>
        </div>

        <!-- Tela do Jogo -->
        <div id="game-screen" class="hidden">
             <!-- HUD: InformaÃ§Ãµes do jogador atual -->
             <div class="grid grid-cols-3 items-center mb-6 text-gray-700 border-b pb-4">
                <div class="text-left">
                    <span class="font-semibold">Jogador:</span>
                    <span id="gamePlayerName" class="font-bold text-lg text-green-700"></span>
                </div>
                <div class="text-center">
                    <span class="font-semibold">Sua PontuaÃ§Ã£o:</span>
                    <span id="score" class="font-bold text-2xl text-green-600">0</span>
                </div>
                <div class="text-right">
                    <span class="font-semibold">Tempo:</span>
                    <span id="timer" class="font-bold text-2xl text-red-600">03:00</span>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Ãrea Principal do Jogo -->
                <div class="flex-grow">
                    <!-- Lixeiras -->
                    <div id="bins-container" class="grid grid-cols-4 md:grid-cols-8 gap-2 mb-6">
                        <!-- Lixeiras serÃ£o geradas aqui -->
                    </div>
                    <!-- ResÃ­duos -->
                    <p class="text-gray-600 mb-4">Arraste o lixo para a lixeira correta!</p>
                    <div id="waste-container" class="flex flex-wrap gap-4 justify-center p-4 bg-gray-100 rounded-lg min-h-[200px] border-2 border-dashed">
                        <!-- ResÃ­duos serÃ£o gerados aqui -->
                    </div>
                </div>
                <!-- Placar -->
                <div id="scoreboard" class="w-full md:w-64 bg-gray-50 p-4 rounded-lg border">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Placar</h3>
                    <div id="scoreboard-list" class="space-y-3">
                        <!-- Lista de pontuaÃ§Ã£o serÃ¡ inserida aqui -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tela de Fim de Jogo (Vencedor) -->
        <div id="winner-screen" class="hidden">
            <h2 class="text-4xl font-bold text-yellow-500 mb-4">ðŸŽ‰ Fim de Jogo! ðŸŽ‰</h2>
            <p id="winner-text" class="text-gray-700 text-2xl mb-2">O vencedor Ã©:</p>
            <h3 id="winner-name" class="text-3xl font-bold text-green-700 mb-8"></h3>
            
            <div class="w-full max-w-md mx-auto bg-gray-50 p-4 rounded-lg border mb-8">
                <h4 class="text-xl font-bold text-gray-800 mb-4 text-center">Placar Final</h4>
                <div id="final-scoreboard-list" class="space-y-3">
                    <!-- Placar final serÃ¡ inserido aqui -->
                </div>
            </div>

            <button id="play-again-button" class="w-full max-w-md mx-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 active:scale-95 transform transition duration-300 text-xl">
                Jogar Novamente
            </button>
        </div>


    </div>

    <!-- Script Firebase e do Jogo -->
    <script type="module">
        // ImportaÃ§Ãµes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURAÃ‡ÃƒO CORRETA DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXSJ6EajgPB-0Yg96vQpncW--0rK5I9Y",
            authDomain: "jogo-de-reciclagem.firebaseapp.com",
            projectId: "jogo-de-reciclagem",
            storageBucket: "jogo-de-reciclagem.appspot.com",
            messagingSenderId: "187212661454",
            appId: "1:187212661454:web:26fb5f7f11499bd297869f"
        };


        // --- INICIALIZAÃ‡ÃƒO ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const playersCollectionRef = collection(db, 'jogo-reciclagem-players');

        // --- ELEMENTOS DA UI ---
        const enterButton = document.getElementById('enterButton');
        const playerNameInput = document.getElementById('playerName');
        const errorMessage = document.getElementById('error-message');
        const startScreen = document.getElementById('start-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const winnerScreen = document.getElementById('winner-screen');
        const playerList = document.getElementById('player-list');
        const readyButton = document.getElementById('readyButton');
        const binsContainer = document.getElementById('bins-container');
        const wasteContainer = document.getElementById('waste-container');
        const scoreDisplay = document.getElementById('score');
        const gamePlayerName = document.getElementById('gamePlayerName');
        const scoreboardList = document.getElementById('scoreboard-list');
        const timerDisplay = document.getElementById('timer');
        const winnerNameDisplay = document.getElementById('winner-name');
        const winnerText = document.getElementById('winner-text');
        const finalScoreboardList = document.getElementById('final-scoreboard-list');
        const playAgainButton = document.getElementById('play-again-button');


        // --- ESTADO DO JOGO ---
        let currentPlayerId = null;
        let currentPlayerName = '';
        let unsubscribeLobby = null;
        let unsubscribeGame = null;
        let isPlayerReady = false;
        let score = 0;
        let gameTimerInterval = null;
        let timeRemaining = 180; // 3 minutos em segundos
        let isGameStarted = false;

        // --- DADOS DO JOGO ---
        const BINS_DATA = [
            { type: 'papel', color: 'bg-blue-500' }, { type: 'plastico', color: 'bg-red-500' },
            { type: 'vidro', color: 'bg-green-600' }, { type: 'metal', color: 'bg-yellow-400' },
            { type: 'organico', color: 'bg-stone-600' }, { type: 'perigoso', color: 'bg-orange-500' },
            { type: 'nao-reciclavel', color: 'bg-gray-800' }, { type: 'hospitalar', color: 'bg-white border-2 border-black' }
        ];

        const WASTE_DATA = [
            { content: 'ðŸ“° Jornal', type: 'papel' }, { content: 'ðŸ“¦ Caixa de PapelÃ£o', type: 'papel' }, { content: 'âœ‰ï¸ Envelope', type: 'papel' }, { content: 'ðŸ“– Revista', type: 'papel' }, { content: 'ðŸ¥› Caixa de Leite', type: 'papel' }, { content: 'ðŸ“ Folha de Papel', type: 'papel' },
            { content: 'ðŸ§´ Garrafa PET', type: 'plastico' }, { content: 'ðŸ¥¤ Copo DescartÃ¡vel', type: 'plastico' }, { content: 'ðŸ›ï¸ Sacola PlÃ¡stica', type: 'plastico' }, { content: 'ðŸ¼ Pote de Iogurte', type: 'plastico' }, { content: 'ðŸ§¸ Brinquedo', type: 'plastico' }, { content: 'ðŸ–Šï¸ Caneta', type: 'plastico' },
            { content: 'ðŸ¾ Garrafa de Vidro', type: 'vidro' }, { content: 'ðŸ· TaÃ§a', type: 'vidro' }, { content: 'ðŸ«™ Pote de Geleia', type: 'vidro' }, { content: 'ðŸ’¡ LÃ¢mpada (Incandescente)', type: 'vidro' }, { content: 'ðŸº Vaso de Vidro', type: 'vidro' }, { content: 'ðŸ¥ƒ Copo de Vidro', type: 'vidro' },
            { content: 'ðŸ¥« Lata de AlumÃ­nio', type: 'metal' }, { content: 'ðŸ“Ž Clipe de Papel', type: 'metal' }, { content: 'ðŸ”© Parafuso', type: 'metal' }, { content: 'ðŸ”‘ Chave', type: 'metal' }, { content: 'ðŸ³ Panela Velha', type: 'metal' }, { content: 'ðŸ´ Talher de Metal', type: 'metal' },
            { content: 'ðŸŽ Resto de MaÃ§Ã£', type: 'organico' }, { content: 'ðŸŒ Casca de Banana', type: 'organico' }, { content: 'ðŸ¥š Casca de Ovo', type: 'organico' }, { content: 'â˜• Borra de CafÃ©', type: 'organico' }, { content: 'ðŸ¥¬ Folhas de Alface', type: 'organico' }, { content: 'ðŸž PÃ£o Velho', type: 'organico' },
            { content: 'ðŸ”‹ Pilha', type: 'perigoso' }, { content: 'ðŸ’¡ LÃ¢mpada Fluorescente', type: 'perigoso' }, { content: 'ðŸ’Š RemÃ©dio Vencido', type: 'perigoso' }, { content: 'ðŸ§ª Tinta', type: 'perigoso' }, { content: 'ðŸ“± Celular Antigo', type: 'perigoso' }, { content: 'ðŸŒ¡ï¸ TermÃ´metro', type: 'perigoso' },
            { content: 'ðŸ§» Papel HigiÃªnico Usado', type: 'nao-reciclavel' }, { content: 'ðŸš¬ Bituca de Cigarro', type: 'nao-reciclavel' }, { content: 'ðŸ§½ Esponja de Cozinha', type: 'nao-reciclavel' }, { content: 'ðŸ©¹ Curativo', type: 'nao-reciclavel' }, { content: 'ðŸª’ LÃ¢mina de Barbear', type: 'nao-reciclavel' }, { content: 'ðŸ“· Fotografia', type: 'nao-reciclavel' },
            { content: 'ðŸ’‰ Seringa', type: 'hospitalar' }, { content: 'ðŸ§¤ Luva CirÃºrgica', type: 'hospitalar' }, { content: 'ðŸ©¸ Gaze com Sangue', type: 'hospitalar' }, { content: 'ðŸ˜· MÃ¡scara DescartÃ¡vel', type: 'hospitalar' }, { content: 'ðŸ”¬ Agulha', type: 'hospitalar' }, { content: ' Cottonete', type: 'hospitalar' },
        ];

        // --- LÃ“GICA DE AUTENTICAÃ‡ÃƒO E LOBBY ---
        async function authenticateUser() {
            try {
                await signInAnonymously(auth);
                currentPlayerId = auth.currentUser.uid;
            } catch (error) { 
                console.error("Erro na autenticaÃ§Ã£o:", error); 
                alert("NÃ£o foi possÃ­vel conectar ao servidor do jogo. Verifique se as chaves do Firebase estÃ£o corretas no cÃ³digo.");
            }
        }

        async function joinGame() {
            currentPlayerName = playerNameInput.value.trim();
            if (!currentPlayerName) {
                errorMessage.textContent = 'Por favor, digite seu nome para continuar.';
                return;
            }
            await authenticateUser();
            if (!currentPlayerId) return;

            const playerDocRef = doc(playersCollectionRef, currentPlayerId);
            await setDoc(playerDocRef, { name: currentPlayerName, isReady: false, score: 0 });

            startScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            listenForPlayerUpdates();
        }

        function listenForPlayerUpdates() {
            unsubscribeLobby = onSnapshot(playersCollectionRef, (snapshot) => {
                const players = [];
                snapshot.forEach((doc) => players.push({ id: doc.id, ...doc.data() }));
                renderPlayerList(players);
                checkAllReady(players);
            });
        }

        function renderPlayerList(players) {
            playerList.innerHTML = '';
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg';
                playerDiv.innerHTML = `
                    <span class="font-semibold text-gray-700">${player.name}</span>
                    <span class="${player.isReady ? 'text-green-500 font-bold' : 'text-yellow-500 waiting-dots'}">
                        ${player.isReady ? 'Pronto!' : 'Aguardando'}
                    </span>`;
                playerList.appendChild(playerDiv);
            });
        }

        async function handleReadyClick() {
            if (!currentPlayerId) return;
            isPlayerReady = !isPlayerReady;
            const playerDocRef = doc(playersCollectionRef, currentPlayerId);
            await setDoc(playerDocRef, { isReady: isPlayerReady }, { merge: true });

            readyButton.textContent = isPlayerReady ? 'NÃ£o estou pronto' : 'Pronto';
            readyButton.classList.toggle('bg-blue-500', !isPlayerReady);
            readyButton.classList.toggle('hover:bg-blue-600', !isPlayerReady);
            readyButton.classList.toggle('bg-red-500', isPlayerReady);
            readyButton.classList.toggle('hover:bg-red-600', isPlayerReady);
        }
        
        function checkAllReady(players) {
            if (isGameStarted) return; 
            if (players.length > 0 && players.every(p => p.isReady)) {
                if (unsubscribeLobby) unsubscribeLobby();
                setTimeout(initializeGame, 1000); 
            }
        }

        // --- LÃ“GICA DO JOGO ---
        function initializeGame() {
            isGameStarted = true; 
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            gamePlayerName.textContent = currentPlayerName;

            renderBins();
            renderWasteItems();
            listenForScoreUpdates();
            startGameTimer();
        }

        function renderBins() {
            binsContainer.innerHTML = '';
            BINS_DATA.forEach(bin => {
                const binEl = document.createElement('div');
                binEl.className = `h-24 w-full rounded-lg shadow-md flex items-center justify-center text-white font-bold text-sm text-center ${bin.color} transition-transform transform hover:scale-105`;
                binEl.dataset.binType = bin.type;
                
                binEl.addEventListener('dragover', handleDragOver);
                binEl.addEventListener('dragenter', handleDragEnter);
                binEl.addEventListener('dragleave', handleDragLeave);
                binEl.addEventListener('drop', handleDrop);
                
                binsContainer.appendChild(binEl);
            });
        }
        
        function renderWasteItems() {
            wasteContainer.innerHTML = '';
            const shuffledWaste = [...WASTE_DATA].sort(() => 0.5 - Math.random());
            shuffledWaste.forEach((waste, index) => {
                const wasteEl = document.createElement('div');
                wasteEl.id = `waste-${index}`;
                wasteEl.className = 'p-3 bg-white rounded-lg shadow-md cursor-grab active:cursor-grabbing text-center';
                wasteEl.textContent = waste.content;
                wasteEl.draggable = true;
                wasteEl.dataset.itemType = waste.type;
                
                wasteEl.addEventListener('dragstart', handleDragStart);
                wasteEl.addEventListener('dragend', handleDragEnd);

                wasteContainer.appendChild(wasteEl);
            });
        }

        function listenForScoreUpdates() {
            unsubscribeGame = onSnapshot(playersCollectionRef, (snapshot) => {
                const players = [];
                snapshot.forEach((doc) => players.push({ id: doc.id, ...doc.data() }));
                renderScoreboard(players);
            });
        }

        function renderScoreboard(players, container = scoreboardList) {
            container.innerHTML = '';
            players.sort((a, b) => b.score - a.score);
            players.forEach(player => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm';
                scoreDiv.innerHTML = `
                    <span class="font-semibold text-gray-700">${player.name}</span>
                    <span class="font-bold text-lg ${player.id === currentPlayerId ? 'text-blue-600' : 'text-gray-800'}">${player.score}</span>
                `;
                container.appendChild(scoreDiv);
            });
        }

        function startGameTimer() {
            timeRemaining = 180;
            updateTimerDisplay(); 
            gameTimerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    endGame('time_up');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const seconds = (timeRemaining % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;

            if (timeRemaining <= 10 && !timerDisplay.classList.contains('animate-pulse')) {
                timerDisplay.classList.add('animate-pulse');
            }
        }

        // --- FUNÃ‡Ã•ES DE ARRASTAR E SOLTAR (DRAG & DROP) ---
        function handleDragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { e.target.classList.add('drag-over'); }
        function handleDragLeave(e) { e.target.classList.remove('drag-over'); }

        async function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');

            const id = e.dataTransfer.getData('text/plain');
            const draggableElement = document.getElementById(id);
            if (!draggableElement || !isGameStarted) return;
            
            const droppedBin = e.target.closest('[data-bin-type]');
            if (!droppedBin) return;

            const itemType = draggableElement.dataset.itemType;
            const binType = droppedBin.dataset.binType;

            if (itemType === binType) {
                score++;
                scoreDisplay.textContent = score;
                const playerDocRef = doc(playersCollectionRef, currentPlayerId);
                await setDoc(playerDocRef, { score: score }, { merge: true });
            } else {
                droppedBin.classList.add('animate-pulse', 'bg-red-700');
                setTimeout(() => droppedBin.classList.remove('animate-pulse', 'bg-red-700'), 500);
            }

            draggableElement.remove();

            if (wasteContainer.children.length === 0) {
                endGame('waste_cleared');
            }
        }
        
        async function endGame(reason = 'waste_cleared') {
            if (!isGameStarted) return;
            isGameStarted = false; 

            clearInterval(gameTimerInterval);
            if (unsubscribeGame) unsubscribeGame();

            const querySnapshot = await getDocs(playersCollectionRef);
            const finalPlayers = [];
            querySnapshot.forEach(doc => finalPlayers.push(doc.data()));

            if (finalPlayers.length > 0) {
                finalPlayers.sort((a, b) => b.score - a.score);
                const highestScore = finalPlayers[0].score;
                const winners = finalPlayers.filter(p => p.score === highestScore);
                const winnerNames = winners.map(w => w.name).join(' e ');
                
                winnerText.textContent = winners.length > 1 ? "Os vencedores sÃ£o:" : "O vencedor Ã©:";
                winnerNameDisplay.textContent = winnerNames;

                renderScoreboard(finalPlayers, finalScoreboardList);
            }

            gameScreen.classList.add('hidden');
            winnerScreen.classList.remove('hidden');
        }

        // --- LIMPEZA ---
        window.addEventListener('beforeunload', async () => {
            clearInterval(gameTimerInterval);
            if (unsubscribeLobby) unsubscribeLobby();
            if (unsubscribeGame) unsubscribeGame();
            if (currentPlayerId) {
                const playerDocRef = doc(playersCollectionRef, currentPlayerId);
                await deleteDoc(playerDocRef);
            }
        });
        
        // --- EVENTOS INICIAIS ---
        enterButton.addEventListener('click', joinGame);
        playerNameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') joinGame();
        });
        readyButton.addEventListener('click', handleReadyClick);
        playAgainButton.addEventListener('click', () => { window.location.reload(); });

    </script>
</body>
</html>

